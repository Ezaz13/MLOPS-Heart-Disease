name: Heart Disease Prediction CI/CD

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: read

jobs:
  ci-pipeline:
    runs-on: self-hosted
    # Default shell for Windows self-hosted runner is usually PowerShell
    defaults:
      run:
        shell: powershell

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: "3.9"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if (Test-Path requirements.txt) { pip install -r requirements.txt }
        pip install pytest flake8 prefect mlflow scikit-learn pandas numpy matplotlib seaborn great_expectations

    - name: Lint with flake8
      run: |
        flake8 src tests --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src tests --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run Unit Tests
      run: |
        pytest tests/

    - name: Execute Data Pipeline & Model Training
      run: |
        $env:PYTHONIOENCODING="utf-8"
        python src/data_pipeline_orchestrator/pipeline.py

    - name: Archive Model Performance Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: model-performance-report
        path: src/model_building/model_performance_report.md

    - name: Archive MLflow Database
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-db
        path: mlflow.db

    - name: Archive MLflow Runs
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-runs
        path: mlruns/

  cd-pipeline:
    needs: ci-pipeline
    runs-on: self-hosted
    if: github.event_name == 'push'
    defaults:
      run:
        shell: powershell

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download MLflow Database
      uses: actions/download-artifact@v4
      with:
        name: mlflow-db
        path: .

    - name: Download MLflow Runs
      uses: actions/download-artifact@v4
      with:
        name: mlflow-runs
        path: mlruns

    - name: Build Docker Image Locally
      run: |
        # Build directly to the local Docker daemon
        docker build -t ezaz13/heart-disease-app:latest .

    - name: Deploy to Local Kubernetes
      run: |
        # Ensure we are using the correct context (this assumes the runner has kubectl configured)
        # Usually 'docker-desktop' context is default if Docker Desktop is running
        
        kubectl apply -f k8/deployment.yaml
        kubectl apply -f k8/service.yaml
        
        Write-Host "Waiting for rollout..."
        kubectl rollout status deployment/heart-disease-app

    - name: Verify Service
      run: |
        # We can hit the localhost directly since it's running on this machine (LoadBalancer/NodePort on Docker Desktop)
        Write-Host "Checking health endpoint..."
        
        # Retry logic for health check
        $retryCount = 0
        $maxRetries = 10
        $healthy = $false

        while ($retryCount -lt $maxRetries) {
            try {
                $response = Invoke-RestMethod -Uri "http://localhost:5000/health" -Method Get -ErrorAction Stop
                if ($response.status -eq "healthy") {
                    Write-Host "Service is HEALTHY."
                    $healthy = $true
                    break
                }
            } catch {
                Write-Host "Waiting for service to be ready... ($retryCount/$maxRetries)"
                Start-Sleep -Seconds 5
            }
            $retryCount++
        }

        if (-not $healthy) {
            Write-Error "Service failed to become healthy."
            exit 1
        }